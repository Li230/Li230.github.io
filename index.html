<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>温馨故事素材管理系统</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        img {
            max-width: 200px;
            max-height: 150px;
            display: block;
        }
        button {
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }
        .request-btn {
            background-color: #2196F3;
            color: white;
        }
        .request-btn:hover {
            background-color: #0b7dda;
        }
        .replace-btn {
            background-color: #ff9800;
            color: white;
        }
        .replace-btn:hover {
            background-color: #e68a00;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        .editable {
            border: 1px solid #ccc;
            padding: 5px;
            min-height: 20px;
        }
        #copyAllBtn, #resetBtn, #saveBtn, #restoreBtn, #addRowBtn {
            padding: 10px 15px;
            margin-bottom: 20px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        #copyAllBtn {
            background-color: #2196F3;
        }
        #copyAllBtn:hover {
            background-color: #0b7dda;
        }
        #resetBtn {
            background-color: #9e9e9e;
        }
        #resetBtn:hover {
            background-color: #757575;
        }
        #saveBtn, #restoreBtn {
            background-color: #673AB7;
        }
        #saveBtn:hover, #restoreBtn:hover {
            background-color: #5E35B1;
        }
        #addRowBtn {
            background-color: #009688;
        }
        #addRowBtn:hover {
            background-color: #00796B;
        }
        #fileInput {
            display: none;
        }
        .button-container {
            margin-bottom: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
        }
        .status-pending {
            background-color: #ff9800;
        }
        .status-success {
            background-color: #4CAF50;
        }
        .status-error {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="button-container">
        <button id="copyAllBtn">一键复制所有URL和时间</button>
        <button id="resetBtn">重置为初始数据</button>
        <button id="saveBtn">导出为JS文件</button>
        <button id="restoreBtn">从JS文件导入</button>
        <button id="addRowBtn">添加新行</button>
        <input type="file" id="fileInput" accept=".js,.json">
    </div>
    <table id="storyTable">
        <thead>
            <tr>
                <th>图片</th>
                <th>字幕</th>
                <th>提示词</th>
                <th>字幕时间</th>
                <th>URL地址</th>
                <th>操作</th>
                <th>替换图片</th>
                <th>删除</th>
            </tr>
        </thead>
        <tbody>
            <!-- 行将由JavaScript动态生成 -->
        </tbody>
    </table>

    <script>
        // 初始数据
        const initialData = {
            urls: [
                "https://p3-bot-workflow-sign.byteimg.com/tos-cn-i-mdko3gqilj/9cb74ca2f7d24e82b5f8aa2206c67967.png~tplv-mdko3gqilj-image.png?rk3s=c8fe7ad5&x-expires=1785382202&x-signature=b9ypN5U1pPtKTW2OXFjGwhqfLZ4%3D"
            ],
            subtitles: [
                "朵朵一直特别想吃棉花糖。"
            ],
            prompts: [
                "Pixel art illustration, a street scene with a cotton candy stand in the background, a girl named Duo Duo looking longingly at a cotton candy in someone else's hand, her expression eager and wistful. The image is entirely in pixel art style."
            ],
            durations: [15]
        };

        // 从localStorage加载数据，如果没有则使用初始数据
        function loadData() {
            const savedData = localStorage.getItem('storyData');
            if (savedData) {
                return JSON.parse(savedData);
            }
            return JSON.parse(JSON.stringify(initialData)); // 深拷贝初始数据
        }

        // 保存数据到localStorage
        function saveData(data) {
            localStorage.setItem('storyData', JSON.stringify(data));
        }

        // 当前数据
        let currentData = loadData();

        // 生成表格行
        const tbody = document.querySelector('#storyTable tbody');

        function createTableRow(i) {
            const row = document.createElement('tr');
            row.dataset.index = i;

            // 图片列
            const imgCell = document.createElement('td');
            const img = document.createElement('img');
            img.src = currentData.urls[i];
            img.alt = `Story image ${i+1}`;
            imgCell.appendChild(img);
            row.appendChild(imgCell);

            // 字幕列 (可编辑)
            const subtitleCell = document.createElement('td');
            subtitleCell.className = 'editable';
            subtitleCell.contentEditable = 'true';
            subtitleCell.textContent = currentData.subtitles[i];
            subtitleCell.addEventListener('blur', function() {
                currentData.subtitles[i] = this.textContent;
                saveData(currentData);
            });
            row.appendChild(subtitleCell);

            // 提示词列 (可编辑)
            const promptCell = document.createElement('td');
            promptCell.className = 'editable';
            promptCell.contentEditable = 'true';
            promptCell.textContent = currentData.prompts[i];
            promptCell.addEventListener('blur', function() {
                currentData.prompts[i] = this.textContent;
                saveData(currentData);
            });
            row.appendChild(promptCell);

            // 时间列 (可编辑)
            const durationCell = document.createElement('td');
            durationCell.className = 'editable';
            durationCell.contentEditable = 'true';
            durationCell.textContent = currentData.durations[i];
            durationCell.addEventListener('blur', function() {
                currentData.durations[i] = parseInt(this.textContent) || 0;
                saveData(currentData);
            });
            row.appendChild(durationCell);

            // URL列 (可编辑)
            const urlCell = document.createElement('td');
            urlCell.className = 'editable';
            urlCell.contentEditable = 'true';
            urlCell.textContent = currentData.urls[i];
            urlCell.addEventListener('blur', function() {
                currentData.urls[i] = this.textContent;
                saveData(currentData);
                // 更新图片
                row.cells[0].querySelector('img').src = this.textContent;
            });
            row.appendChild(urlCell);

            // 发送请求按钮列
            const requestCell = document.createElement('td');
            const requestBtn = document.createElement('button');
            requestBtn.textContent = '发送请求';
            requestBtn.className = 'request-btn';

            // 添加状态指示器
            const statusIndicator = document.createElement('span');
            statusIndicator.className = 'status-indicator';
            statusIndicator.style.display = 'none';

            requestBtn.appendChild(statusIndicator);

            requestBtn.onclick = async function() {
    const rowIndex = parseInt(this.parentNode.parentNode.dataset.index);
    const currentPrompt = currentData.prompts[rowIndex];
    const currentSubtitle = currentData.subtitles[rowIndex];
    const row = this.parentNode.parentNode;

    // 显示加载状态
    statusIndicator.className = 'status-indicator status-pending';
    statusIndicator.style.display = 'inline-block';
    requestBtn.disabled = true;

    try {
        const response = await fetch('https://api.coze.cn/v1/workflow/stream_run', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer pat_YzxesjuMexhNfLm4GUXY4KXRsUl4jMWmzW9CN8WeKuhu64nt3LrwBonkrjW5inG4',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                workflow_id: '7530480341447573540',
                parameters: {
                    "image_prompt": currentPrompt,
                    "image_cap": currentSubtitle
                }
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // 处理流式响应
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            fullText += chunk;

            // 尝试从流中提取图片URL
            try {
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const dataStr = line.substring(6).trim();
                        if (dataStr) {
                            const data = JSON.parse(dataStr);
                            if (data.content) {
                                const content = JSON.parse(data.content);
                                if (content.image) {
                                    // 找到图片URL，更新行数据
                                    const imageUrl = content.image;

                                    // 更新数据
                                    currentData.urls[rowIndex] = imageUrl;
                                    saveData(currentData);

                                    // 更新UI
                                    row.cells[0].querySelector('img').src = imageUrl;
                                    row.cells[4].textContent = imageUrl;

                                    // 显示成功状态
                                    statusIndicator.className = 'status-indicator status-success';
                                    alert('图片已成功更新！');
                                }
                            }
                        }
                    }
                }
            } catch (e) {
                console.log('解析流数据时出错:', e);
            }
        }

        // 3秒后隐藏状态指示器
        setTimeout(() => {
            statusIndicator.style.display = 'none';
            requestBtn.disabled = false;
        }, 3000);

    } catch (error) {
        console.error('请求失败:', error);

        // 显示错误状态
        statusIndicator.className = 'status-indicator status-error';

        // 3秒后隐藏状态指示器
        setTimeout(() => {
            statusIndicator.style.display = 'none';
            requestBtn.disabled = false;
        }, 3000);

        // 提供更详细的错误信息
        let errorMessage = error.message;
        if (error instanceof SyntaxError) {
            errorMessage = '服务器返回了无效的JSON响应';
        }

        alert('请求发送失败: ' + errorMessage);
    }
};
            requestCell.appendChild(requestBtn);
            row.appendChild(requestCell);

            // 替换图片按钮列
            const replaceCell = document.createElement('td');
            const replaceBtn = document.createElement('button');
            replaceBtn.textContent = '替换图片URL';
            replaceBtn.className = 'replace-btn';
            replaceBtn.onclick = function() {
                const rowIndex = parseInt(this.parentNode.parentNode.dataset.index);
                const currentUrl = currentData.urls[rowIndex];
                const newUrl = prompt('请输入新的图片URL:', currentUrl);
                if (newUrl && newUrl !== currentUrl) {
                    // 更新数据
                    currentData.urls[rowIndex] = newUrl;
                    // 保存到localStorage
                    saveData(currentData);
                    // 更新UI
                    const img = this.parentNode.parentNode.cells[0].querySelector('img');
                    img.src = newUrl;
                    this.parentNode.parentNode.cells[4].textContent = newUrl;
                }
            };
            replaceCell.appendChild(replaceBtn);
            row.appendChild(replaceCell);

            // 删除行按钮列
            const deleteCell = document.createElement('td');
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '删除行';
            deleteBtn.className = 'delete-btn';
            deleteBtn.onclick = function() {
                if (confirm('确定要删除这一行吗？')) {
                    const rowIndex = parseInt(this.parentNode.parentNode.dataset.index);
                    // 从数据中删除
                    currentData.urls.splice(rowIndex, 1);
                    currentData.subtitles.splice(rowIndex, 1);
                    currentData.prompts.splice(rowIndex, 1);
                    currentData.durations.splice(rowIndex, 1);
                    // 保存
                    saveData(currentData);
                    // 从DOM中删除
                    this.parentNode.parentNode.remove();
                    // 重新索引剩余的行
                    updateRowIndexes();
                }
            };
            deleteCell.appendChild(deleteBtn);
            row.appendChild(deleteCell);

            return row;
        }

        // 更新所有行的索引
        function updateRowIndexes() {
            const rows = document.querySelectorAll('#storyTable tbody tr');
            rows.forEach((row, index) => {
                row.dataset.index = index;
            });
        }

        // 初始化表格
        function initializeTable() {
            tbody.innerHTML = '';
            for (let i = 0; i < currentData.urls.length; i++) {
                tbody.appendChild(createTableRow(i));
            }
        }

        // 添加新行
        document.getElementById('addRowBtn').addEventListener('click', function() {
            // 添加空数据
            currentData.urls.push('');
            currentData.subtitles.push('');
            currentData.prompts.push('');
            currentData.durations.push(0);
            // 保存
            saveData(currentData);
            // 添加新行
            tbody.appendChild(createTableRow(currentData.urls.length - 1));
        });

        // 重置按钮
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (confirm('确定要重置为初始数据吗？所有修改将丢失！')) {
                localStorage.removeItem('storyData');
                currentData = JSON.parse(JSON.stringify(initialData)); // 深拷贝初始数据
                initializeTable();
            }
        });

        // 导出为JS文件
        document.getElementById('saveBtn').addEventListener('click', function() {
            // 创建一个包含initialData的JS文件内容
            const jsContent = `const initialData = ${JSON.stringify(currentData, null, 2)};\n`;

            // 创建一个Blob对象
            const dataBlob = new Blob([jsContent], {type: 'application/javascript'});

            // 创建一个下载链接
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(dataBlob);
            downloadLink.download = 'story-data.js';

            // 触发点击事件
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        });

        // 从JS文件导入
        document.getElementById('restoreBtn').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // 尝试解析JS文件内容
                    const jsContent = e.target.result;
                    // 提取initialData对象
                    const dataMatch = jsContent.match(/const initialData = (\{[\s\S]*?\});/);
                    if (!dataMatch) {
                        throw new Error('未找到initialData定义');
                    }

                    // 使用Function构造函数安全地解析对象
                    const getInitialData = new Function(`${dataMatch[0]} return initialData;`);
                    const jsonData = getInitialData();

                    if (confirm('确定要从文件导入数据吗？当前数据将被覆盖！')) {
                        // 更新currentData
                        currentData = jsonData;
                        // 保存到localStorage
                        saveData(currentData);
                        // 重新初始化表格
                        initializeTable();
                        alert('数据导入成功！');
                    }
                } catch (error) {
                    alert('文件解析失败，请确保选择的是有效的JS数据文件！');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        });

        // 一键复制所有URL和时间
        document.getElementById('copyAllBtn').addEventListener('click', function() {
            const currentUrls = [];
            const currentDurations = [];

            const rows = document.querySelectorAll('#storyTable tbody tr');
            rows.forEach(row => {
                currentUrls.push(row.cells[4].textContent);
                currentDurations.push(parseInt(row.cells[3].textContent));
            });

            const textToCopy = `图片url: [${currentUrls.map(url => `"${url}"`).join(',')}]       字幕时间: [${currentDurations.join(',')}]`;

            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('所有URL和时间已复制到剪贴板！');
            });
        });

        // 初始化页面
        initializeTable();

     window.difyChatbotConfig = {
  token: 'tNcfwW3ghBxTkShh',
  systemVariables: {
    // user_id: 'YOU CAN DEFINE USER ID HERE',
    // conversation_id: 'YOU CAN DEFINE CONVERSATION ID HERE, IT MUST BE A VALID UUID',
  },
  userVariables: {
    // avatar_url: 'YOU CAN DEFINE USER AVATAR URL HERE',
    // name: 'YOU CAN DEFINE USER NAME HERE',
  },
 }
</script>
<script
 src="https://udify.app/embed.min.js"
 id="tNcfwW3ghBxTkShh"
 defer>
</script>
<style>
  #dify-chatbot-bubble-button {
    background-color: #1C64F2 !important;
  }
  #dify-chatbot-bubble-window {
    width: 24rem !important;
    height: 40rem !important;
  }
        
    </script>
    
</body>
</html>
